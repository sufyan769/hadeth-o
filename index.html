<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>باحث الأحاديث</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri+Quran&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Amiri Quran', serif;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/client": "https://aistudiocdn.com/react-dom@^19.2.0/client",
    "react-router-dom": "https://aistudiocdn.com/react-router-dom@^7.9.4"
  }
}
</script>
</head>
  <body class="bg-gray-50 text-gray-800">
    <div id="root"></div>
    <script type="module">
      import React, { useState, useEffect, useMemo, StrictMode } from 'react';
      import ReactDOM from 'react-dom/client';
      import { HashRouter, Routes, Route, useParams, useNavigate, Link, useLocation } from 'react-router-dom';

      // =================================================================
      // === SERVICES
      // =================================================================
      const ORACLE_API_URL = 'https://g85b062bd5c6cb1-fatwaproject.adb.me-dubai-1.oraclecloudapps.com/ords/SUFEAN/hadeeth/search_combined/';

      // Helper to process Oracle API search results
      const processOracleHits = (data) => {
        if (!data || !data.items || !Array.isArray(data.items)) return [];
        return data.items.map((item) => ({
          id: item.hadeeth_id?.toString() || `${Date.now()}-${Math.random()}`, // Ensure ID is a unique string
          text: item.hadeeth_text || '',
          sharh: item.sharh || '',
          rawi: item.rawi || '',
          muhaddith: item.muhaddith || '',
          source: item.source || '',
          page_number: item.page_or_number || '',
          hukm: item.hukm_on_hadeeth || '',
          takhrij: item.takhreej || '',
          categories: item.book_category ? [item.book_category] : [],
          century: item.century || undefined,
        }));
      };

      const searchHadiths = async (query) => {
        try {
          if (!query || query.trim() === '') return [];
          
          // The `fetch` API automatically handles encoding of special characters in the URL path.
          // We pass the raw query string and let the browser handle the encoding, which can be more reliable.
          const response = await fetch(`${ORACLE_API_URL}${query}`);

          if (!response.ok) {
              // Log the response status and text to help debug API errors from the server.
              const errorText = await response.text();
              console.error(`Oracle API query failed with status ${response.status}: ${response.statusText}`, errorText);
              throw new Error(`Oracle API query failed: ${response.statusText}`);
          }
          const json = await response.json();
          return processOracleHits(json);
        } catch (error) {
          // Log the full error object. This is crucial for diagnosing network-level issues like CORS.
          console.error("An error occurred in the searchHadiths function:", error);
          return [];
        }
      };

      // =================================================================
      // === HOOKS
      // =================================================================
      function useQuery() {
        const { search } = useLocation();
        return React.useMemo(() => new URLSearchParams(search), [search]);
      }

      // =================================================================
      // === ICONS
      // =================================================================
      const SVGProps = {
        className: "w-5 h-5", viewBox: "0 0 24 24", fill: "none",
        stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round",
      };
      const CopyIcon = (props) => React.createElement('svg', {...SVGProps, ...props}, 
        React.createElement('rect', {x:"9", y:"9", width:"13", height:"13", rx:"2", ry:"2"}),
        React.createElement('path', {d:"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"})
      );
      const CheckIcon = (props) => React.createElement('svg', {...SVGProps, ...props, className: `w-5 h-5 text-green-500`}, 
        React.createElement('polyline', {points:"20 6 9 17 4 12"})
      );
      const ShareIcon = (props) => React.createElement('svg', {...SVGProps, ...props},
        React.createElement('circle', {cx:"18", cy:"5", r:"3"}),
        React.createElement('circle', {cx:"6", cy:"12", r:"3"}),
        React.createElement('circle', {cx:"18", cy:"19", r:"3"}),
        React.createElement('line', {x1:"8.59", y1:"13.51", x2:"15.42", y2:"17.49"}),
        React.createElement('line', {x1:"15.41", y1:"6.51", x2:"8.59", y2:"10.49"})
      );
      const FontSizeIncreaseIcon = (props) => React.createElement('svg', {...SVGProps, ...props},
        React.createElement('path', {d:"M4 7V5h12v2M10 5v14m-3-3h6m5 0v-2h-3v-1h3v-2h-3v-1h2l-3-4-3 4h2v1h-3v2h3v1h-3v2h3"})
      );
      const FontSizeDecreaseIcon = (props) => React.createElement('svg', {...SVGProps, ...props},
        React.createElement('path', {d:"M4 7V5h8v2M8 5v14m-3 3h6m7-3v-2h-3v-1h3v-2h-3v-1h2l-3-4-3 4h2v1h-3v2h3v1h-3v2h3"})
      );
      const BackIcon = (props) => React.createElement('svg', {...SVGProps, ...props},
        React.createElement('path', {d:"M15 18l-6-6 6-6"})
      );
      const SearchIcon = (props) => React.createElement('svg', {...SVGProps, ...props, className: `w-6 h-6 text-gray-500`},
        React.createElement('circle', {cx:"11", cy:"11", r:"8"}),
        React.createElement('line', {x1:"21", y1:"21", x2:"16.65", y2:"16.65"})
      );

      // =================================================================
      // === COMPONENTS
      // =================================================================
      const LoadingSpinner = () => (
        React.createElement('div', { className: "flex justify-center items-center p-8" },
          React.createElement('div', { className: "w-10 h-10 border-4 border-teal-600 border-dashed rounded-full animate-spin" })
        )
      );

      const HighlightedText = ({ text, highlight }) => {
        if (!highlight || !text || highlight.trim() === '') {
          return React.createElement(React.Fragment, null, text);
        }
        const highlightWords = highlight.replace(/[+-]/g, ' ').split(' ').filter(w => w);
        if (highlightWords.length === 0) {
            return React.createElement(React.Fragment, null, text);
        }
        const regex = new RegExp(`(${highlightWords.join('|')})`, 'gi');
        const parts = text.split(regex);

        return React.createElement('span', null,
          parts.map((part, i) => {
            const isMatch = highlightWords.some(hWord => part.toLowerCase() === hWord.toLowerCase());
            return isMatch
              ? React.createElement('mark', { key: i, className: "bg-yellow-300 px-1 rounded" }, part)
              : part;
          })
        );
      };

      const SearchBar = ({ onSearch, isLoading }) => {
        const [query, setQuery] = useState('');

        const handleSearch = (e) => {
          e.preventDefault();
          if (query.trim()) {
             onSearch(query);
          }
        };

        return React.createElement('div', { className: "w-full max-w-3xl mx-auto bg-white p-4 rounded-xl shadow-lg" },
          React.createElement('form', { onSubmit: handleSearch },
            React.createElement('div', { className: "relative" },
              React.createElement('input', {
                type: "text", value: query, onChange: (e) => setQuery(e.target.value),
                placeholder: "ابحث في الأحاديث...",
                className: "w-full pl-12 pr-4 py-3 bg-gray-100 border-2 border-transparent focus:border-teal-500 focus:ring-teal-500 rounded-lg text-lg text-gray-800 transition",
                disabled: isLoading
              }),
              React.createElement('div', { className: "absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none" },
                React.createElement(SearchIcon, null)
              )
            ),
            React.createElement('button', {
              type: "submit",
              className: "mt-4 w-full bg-teal-600 text-white py-3 rounded-lg text-lg font-bold hover:bg-teal-700 focus:outline-none focus:ring-4 focus:ring-teal-300 transition-colors duration-300 disabled:bg-teal-400 disabled:cursor-not-allowed",
              disabled: isLoading
            }, isLoading ? 'جاري البحث...' : 'بحث')
          )
        );
      };

      const HadithCard = ({ hadith, query, results }) => {
        const snippet = hadith.text.length > 120 ? `${hadith.text.substring(0, 120)}...` : hadith.text;

        return React.createElement(Link, {
            to: `/hadith/${hadith.id}?q=${encodeURIComponent(query)}`,
            state: { searchResults: results },
            className: "block py-5 px-4 hover:bg-gray-100 transition duration-150"
          },
          React.createElement('p', { className: "text-lg text-gray-800 leading-relaxed mb-3" },
            snippet,
            hadith.text.length > 120 && React.createElement('span', { className: "text-teal-600 hover:text-teal-800 font-semibold mr-2" }, " أكمل القراءة")
          ),
          React.createElement('div', { className: "flex items-center text-sm text-gray-500" },
            React.createElement('span', null, `الراوي: ${hadith.rawi}`),
            React.createElement('span', { className: "mx-2 text-gray-300" }, '•'),
            React.createElement('span', null, `المصدر: ${hadith.source}`)
          )
        );
      };

      // =================================================================
      // === PAGES
      // =================================================================
      const HomePage = () => {
        const [searchResults, setSearchResults] = useState([]);
        const [isLoading, setIsLoading] = useState(false);
        const [query, setQuery] = useState('');
        const [hasSearched, setHasSearched] = useState(false);

        const handleSearch = async (searchQuery) => {
          setIsLoading(true);
          setHasSearched(true);
          setQuery(searchQuery);
          const results = await searchHadiths(searchQuery);
          setSearchResults(results);
          setIsLoading(false);
        };
        
        const renderHadithList = (hadiths, currentQuery) => (
          React.createElement('div', { className: "bg-white rounded-lg shadow-md divide-y divide-gray-200" },
            hadiths.map((hadith) => 
              React.createElement(HadithCard, { key: `${hadith.id}-${hadith.source}`, hadith: hadith, query: currentQuery, results: hadiths })
            )
          )
        );

        return React.createElement('div', { className: "min-h-screen" },
          React.createElement('main', { className: "container mx-auto p-4 sm:p-6 lg:p-8" },
            React.createElement('header', { className: "text-center mb-12" },
              React.createElement('h1', { className: "text-4xl sm:text-5xl font-bold text-teal-800" }, 'باحث الأحاديث الشريفة'),
              React.createElement('p', { className: "text-lg text-gray-600 mt-2" }, 'ابحث في كنوز السنة النبوية')
            ),
            React.createElement('div', { className: "sticky top-4 z-10 py-2 bg-gray-50 bg-opacity-80 backdrop-blur-sm" },
              React.createElement(SearchBar, { onSearch: handleSearch, isLoading: isLoading })
            ),
            React.createElement('div', { className: "mt-8" },
              isLoading ? React.createElement(LoadingSpinner, null)
              : hasSearched ? React.createElement('div', null,
                React.createElement('h2', { className: "text-2xl font-bold mb-4 text-gray-700" }, `نتائج البحث عن "${query}" (${searchResults.length})`),
                searchResults.length > 0
                  ? renderHadithList(searchResults, query)
                  : React.createElement('div', { className: "text-center bg-white p-8 rounded-lg shadow-md" },
                      React.createElement('p', { className: "text-xl text-gray-600" }, 'لم يتم العثور على نتائج. حاول البحث بكلمات مختلفة.')
                    )
              )
              : React.createElement('div', { className: "text-center text-gray-500 pt-10" },
                  React.createElement('p', null, "أدخل مصطلح بحث للبدء.")
                )
            )
          )
        );
      };

      const HadithDetailPage = () => {
        const { id } = useParams();
        const navigate = useNavigate();
        const location = useLocation();
        const query = useQuery();

        const [hadith, setHadith] = useState(null);
        const [isLoading, setIsLoading] = useState(false);
        const [isCopied, setIsCopied] = useState(false);
        const [fontSize, setFontSize] = useState('text-2xl');

        const searchQuery = useMemo(() => query.get('q') || '', [query]);
        const searchResults = location.state?.searchResults;

        useEffect(() => {
          const hadithFromState = searchResults?.find(h => h.id.toString() === id);
          if (hadithFromState) {
              setHadith(hadithFromState);
          } else {
              setHadith(null); // No fallback, as getById is removed
          }
          window.scrollTo(0, 0);
        }, [id, searchResults]);

        const handleCopy = () => {
          if (hadith) {
            const textToCopy = `الحديث: ${hadith.text}\n\n${hadith.sharh ? `الشرح: ${hadith.sharh}\n\n` : ''}المصدر: ${hadith.source}\nالرابط: ${window.location.href}`;
            navigator.clipboard.writeText(textToCopy);
            setIsCopied(true);
            setTimeout(() => setIsCopied(false), 2000);
          }
        };

        const handleShare = async () => {
          if (hadith && navigator.share) {
            const shareData = { title: `حديث: ${hadith.source}`, text: hadith.text.substring(0, 100) + '...', url: window.location.href };
            try {
              await navigator.share(shareData);
            } catch (err) {
              console.error('Error sharing:', err);
            }
          } else {
              alert('المشاركة غير مدعومة في هذا المتصفح. يمكنك نسخ الرابط يدوياً.');
          }
        };

        const changeFontSize = (direction) => {
          const sizes = ['text-lg', 'text-xl', 'text-2xl', 'text-3xl', 'text-4xl'];
          const currentIndex = sizes.indexOf(fontSize);
          if (direction === 'increase' && currentIndex < sizes.length - 1) setFontSize(sizes[currentIndex + 1]);
          if (direction === 'decrease' && currentIndex > 0) setFontSize(sizes[currentIndex - 1]);
        };
        
        const currentIndex = useMemo(() => {
          if (!searchResults || !id) return -1;
          return searchResults.findIndex(res => res.id.toString() === id);
        }, [searchResults, id]);

        const navigateToResult = (direction) => {
          if (!searchResults || currentIndex === -1) return;
          const newIndex = direction === 'next' ? currentIndex + 1 : currentIndex - 1;
          if (newIndex >= 0 && newIndex < searchResults.length) {
            const nextHadith = searchResults[newIndex];
            navigate(`/hadith/${nextHadith.id}?q=${searchQuery}`, { state: { searchResults } });
          }
        };
        
        if (!hadith) {
          return React.createElement('div', { className: "text-center p-8" }, 'لم يتم العثور على الحديث. قد يكون الرابط مباشر وتحتاج للبحث أولاً.');
        }
        
        const hasPrev = currentIndex > 0;
        const hasNext = currentIndex !== -1 && currentIndex < (searchResults?.length ?? 0) - 1;

        return React.createElement('div', { className: "max-w-4xl mx-auto p-4 sm:p-8" },
          React.createElement('div', { className: "bg-white rounded-xl shadow-lg p-6 sm:p-10 relative" },
            React.createElement('div', { className: "absolute top-4 right-4 sm:top-6 sm:right-6" },
              React.createElement('button', { onClick: () => navigate(-1), className: "p-2 rounded-full hover:bg-gray-200 transition", 'aria-label': "العودة" }, React.createElement(BackIcon, null))
            ),
            React.createElement('div', { className: "mb-6 border-b pb-6" },
              React.createElement('h2', { className: "text-3xl font-bold text-teal-800 mb-4" }, 'نص الحديث'),
              React.createElement('p', { className: `${fontSize} text-black leading-loose` }, React.createElement(HighlightedText, { text: hadith.text, highlight: searchQuery }))
            ),
            hadith.sharh && hadith.sharh.trim() !== '' ?
              React.createElement('div', { className: "mb-8" },
                React.createElement('h2', { className: "text-xl font-bold text-teal-800 mb-4" }, 'الشرح'),
                React.createElement('p', { className: "text-lg text-gray-700 leading-relaxed whitespace-pre-wrap" }, React.createElement(HighlightedText, { text: hadith.sharh, highlight: searchQuery }))
              ) :
              React.createElement('div', { className: "mb-8" },
                React.createElement('h2', { className: "text-xl font-bold text-teal-800 mb-4" }, 'الشرح'),
                React.createElement('p', { className: "text-gray-600 italic" }, 'لا يوجد شرح متوفر لهذا الحديث.')
              ),
            React.createElement('div', { className: "border-t border-b py-4 my-6 text-gray-600 text-base" },
              React.createElement('div', { className: "grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3" },
                React.createElement('p', null, React.createElement('strong', null, 'الراوي:'), ` ${hadith.rawi}`),
                React.createElement('p', null, React.createElement('strong', null, 'المحدث:'), ` ${hadith.muhaddith}`),
                React.createElement('p', null, React.createElement('strong', null, 'المصدر:'), ` ${hadith.source}`),
                React.createElement('p', null, React.createElement('strong', null, 'رقم/صفحة:'), ` ${hadith.page_number}`),
                React.createElement('p', null, React.createElement('strong', null, 'الحكم:'), ` ${hadith.hukm}`),
                React.createElement('p', { className: "sm:col-span-2" }, React.createElement('strong', null, 'التخريج:'), ` ${hadith.takhrij}`)
              )
            ),
             hadith.categories && hadith.categories.length > 0 && React.createElement('div', { className: "mb-6" },
              React.createElement('h3', { className: "font-bold text-lg mb-3 text-teal-800" }, 'التصنيفات:'),
              React.createElement('div', { className: "flex flex-wrap gap-2" },
                hadith.categories.map((category, index) =>
                  React.createElement(Link, {
                    key: index, to: `/?q=${encodeURIComponent(category.split(' - ')[0])}`,
                    className: "bg-teal-100 text-teal-800 px-3 py-1 rounded-full text-sm hover:bg-teal-200 transition"
                  }, category)
                )
              )
            ),
            React.createElement('div', { className: "flex flex-wrap items-center justify-between gap-4 pt-6" },
                React.createElement('div', {className: "flex items-center gap-2"},
                    React.createElement('button', { onClick: handleCopy, className: "flex items-center gap-2 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition" }, isCopied ? React.createElement(CheckIcon, null) : React.createElement(CopyIcon, null), isCopied ? 'تم النسخ' : 'نسخ'),
                    React.createElement('button', { onClick: handleShare, className: "flex items-center gap-2 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition" }, React.createElement(ShareIcon, null), 'مشاركة'),
                    React.createElement('button', { onClick: () => changeFontSize('increase'), 'aria-label': "تكبير الخط", className: "p-2 rounded-lg hover:bg-gray-200 transition" }, React.createElement(FontSizeIncreaseIcon, null)),
                    React.createElement('button', { onClick: () => changeFontSize('decrease'), 'aria-label': "تصغير الخط", className: "p-2 rounded-lg hover:bg-gray-200 transition" }, React.createElement(FontSizeDecreaseIcon, null))
                ),
                searchResults && searchResults.length > 0 && React.createElement('div', {className: "flex items-center gap-2"},
                    React.createElement('button', { onClick: () => navigateToResult('prev'), disabled: !hasPrev, className: "bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 disabled:bg-teal-300 disabled:cursor-not-allowed transition" }, "السابق"),
                    React.createElement('span', {className: "text-gray-600 font-mono"}, `${currentIndex + 1} / ${searchResults.length}`),
                    React.createElement('button', { onClick: () => navigateToResult('next'), disabled: !hasNext, className: "bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 disabled:bg-teal-300 disabled:cursor-not-allowed transition" }, "التالي")
                )
            )
          )
        );
      };

      // =================================================================
      // === APP ROOT
      // =================================================================
      const App = () => (
        React.createElement(HashRouter, null,
          React.createElement(Routes, null,
            React.createElement(Route, { path: "/", element: React.createElement(HomePage, null) }),
            React.createElement(Route, { path: "/hadith/:id", element: React.createElement(HadithDetailPage, null) })
          )
        )
      );

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(React.createElement(StrictMode, null, React.createElement(App, null)));
    </script>
  </body>
</html>
