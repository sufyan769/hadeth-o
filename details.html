<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>تفاصيل الحديث</title>
  <meta name="description" content="البحث في الأحاديث النبوية الشريفة والفتاوى.">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Amiri', serif;
      background-color: #FDF6E3; /* Vintage paper background */
    }
    .hadith-card {
        background-color: #FFFBF2;
        border: 1px solid #EAE1D0;
    }
    .hadith-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        border-color: #c7a46e;
    }
     .animate-spin {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="text-stone-800">
  <main id="main-content" class="max-w-4xl mx-auto p-4 sm:p-6 md:p-8">
    <!-- Content will be rendered here by JavaScript -->
  </main>
  
  <div id="fab-container" style="cursor: move; display: none;" class="fixed bottom-4 right-4 flex items-center gap-3 z-50">
    <a href="./index.html" class="bg-stone-600 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center hover:bg-stone-700 transition-colors" aria-label="العودة" title="العودة للبحث">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
      </svg>
    </a>
    <button id="font-size-toggle-btn" class="bg-amber-600 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center text-xl font-bold hover:bg-amber-700 transition-colors" aria-label="تغيير حجم الخط" title="تغيير حجم الخط">A+</button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONSTANTS ---
        const ORDS_API_BASE_URL = "https://g85b062bd5c6cb1-fatwaproject.adb.me-dubai-1.oraclecloudapps.com/ords/SUFEAN/hadith_full_api";
        const ALGOLIA_APP_ID = "3XD12I7386";
        const ALGOLIA_SEARCH_KEY = "89e8e132a05fdb02275f64dec8d14d05";
        const ALGOLIA_INDEX_NAME = "ahadith_clean";

        // --- ELEMENTS ---
        const mainContent = document.getElementById('main-content');
        const fabContainer = document.getElementById('fab-container');
        
        // --- HELPER FUNCTIONS ---
        const renderSpinner = (size = 'lg') => {
            const sizeClasses = { sm: 'w-8 h-8', md: 'w-10 h-10', lg: 'w-12 h-12' };
            return `<div class="flex justify-center items-center py-10"><div class="${sizeClasses[size]} border-4 border-amber-500 border-t-transparent rounded-full animate-spin"></div></div>`;
        };

        const renderError = (message) => {
            mainContent.innerHTML = `<p class="text-center text-red-500 mt-10">${message}</p>`;
        };

        // --- FONT SIZE CONTROL ---
        const initFontSizeControl = () => {
            const toggleBtn = document.getElementById('font-size-toggle-btn');
            if (!toggleBtn) return;
            const FONT_SIZES = [16, 18, 20, 22];
            const LS_KEY = 'hadithAppFontSize';
            const applyFontSize = (size) => {
                document.documentElement.style.fontSize = `${size}px`;
                localStorage.setItem(LS_KEY, size);
            };
            const getCurrentSizeIndex = () => {
                const currentSize = parseInt(localStorage.getItem(LS_KEY) || FONT_SIZES[0], 10);
                const index = FONT_SIZES.indexOf(currentSize);
                return index === -1 ? 0 : index;
            };
            const savedSize = localStorage.getItem(LS_KEY);
            if (savedSize) applyFontSize(parseInt(savedSize, 10));
            toggleBtn.addEventListener('click', () => {
                const currentIndex = getCurrentSizeIndex();
                const nextIndex = (currentIndex + 1) % FONT_SIZES.length;
                applyFontSize(FONT_SIZES[nextIndex]);
            });
        };
        
        // --- DRAGGABLE FAB ---
        const makeFabDraggable = () => {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            fabContainer.onmousedown = dragMouseDown;
            function dragMouseDown(e) {
                e.preventDefault();
                pos3 = e.clientX; pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }
            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
                pos3 = e.clientX; pos4 = e.clientY;
                fabContainer.style.top = (fabContainer.offsetTop - pos2) + "px";
                fabContainer.style.left = (fabContainer.offsetLeft - pos1) + "px";
                fabContainer.style.bottom = 'auto'; fabContainer.style.right = 'auto';
            }
            function closeDragElement() {
                document.onmouseup = null; document.onmousemove = null;
            }
        };
        
        const createMetadataBlock = (metadata) => {
             const points = [
                { label: 'الراوي', value: metadata.rawi },
                { label: 'المحدث', value: metadata.muhaddith },
                { label: 'المصدر', value: metadata.source },
                { label: 'الصفحة أو الرقم', value: metadata.page_number },
                { label: 'الحكم', value: metadata.hukm },
                { label: 'التخريج', value: metadata.takhrij }
            ];
            const itemsHtml = points.filter(item => item.value).map(item => 
                `<div class="py-2 px-3 bg-stone-100/70 rounded-md flex items-baseline">
                    <strong class="text-stone-600 font-bold ml-3 flex-shrink-0">${item.label}:</strong>
                    <span class="text-stone-800">${item.value}</span>
                </div>`
            ).join('');
            return itemsHtml.length > 0 ? `<div class="border-b border-stone-200 pb-4 mb-6"><h2 class="text-2xl font-bold text-amber-800 mb-3">بيانات الحديث</h2><div class="space-y-2 text-md">${itemsHtml}</div></div>` : '';
        };

        const fetchRelatedHadiths = async (text, currentId) => {
            if (typeof algoliasearch === 'undefined') return '';
            const client = algoliasearch(ALGOLIA_APP_ID, ALGOLIA_SEARCH_KEY);
            const index = client.initIndex(ALGOLIA_INDEX_NAME);
            try {
                const { hits } = await index.search(text, { hitsPerPage: 7 });
                const related = hits.filter(hit => hit.objectID !== currentId).slice(0, 6);
                if (related.length === 0) return '';
                const relatedHTML = related.map(h => `<a href="./details.html?id=${h.objectID}" class="block hadith-card p-5 rounded-xl"><p class="text-stone-700 leading-relaxed text-lg">${h.text}</p></a>`).join('');
                return `<section class="mt-12"><h2 class="text-2xl font-bold text-stone-700 mb-4">أحاديث ذات صلة</h2><div class="space-y-4">${relatedHTML}</div></section>`;
            } catch (e) {
                return '';
            }
        };

        // --- MAIN LOGIC ---
        const loadHadith = async () => {
            mainContent.innerHTML = renderSpinner();
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');

            if (!id) {
                renderError("لم يتم تحديد حديث.");
                return;
            }

            try {
                const response = await fetch(`${ORDS_API_BASE_URL}/${id}`);
                if (!response.ok) throw new Error('حدث خطأ في جلب البيانات أو أن الحديث غير موجود.');
                const data = await response.json();
                
                if (data.items && data.items.length > 0) {
                    const hadith = data.items[0];
                    const metadataHTML = createMetadataBlock(hadith);
                    const categoriesHTML = hadith.categories ? hadith.categories.split('|').map(cat => cat.trim()).filter(Boolean)
                        .map(cat => `<a href="./category.html?q=${encodeURIComponent(cat)}" class="inline-block bg-amber-100 text-amber-800 text-sm font-medium me-2 px-3 py-1 rounded-full hover:bg-amber-200">${cat}</a>`).join('') : '';

                    const relatedHadithsHTML = await fetchRelatedHadiths(hadith.text, id);
                    
                    mainContent.innerHTML = `
                        <div class="bg-[#FFFBF2] rounded-xl shadow-lg p-6 sm:p-8 border-2 border-stone-200">
                            <div class="border-b border-stone-200 pb-4 mb-4">
                                <h2 class="text-2xl font-bold text-amber-800 mb-2">الحديث</h2>
                                <p class="text-stone-700 whitespace-pre-wrap leading-loose text-lg">${hadith.text}</p>
                            </div>
                            ${metadataHTML}
                             <div class="mt-8">
                                <button id="logical-search-btn" class="inline-block px-6 py-3 bg-teal-700 text-white font-bold rounded-lg hover:bg-teal-800 transition-colors">في رواية اخرى</button>
                             </div>
                            ${categoriesHTML ? `<div class="mt-8 mb-6"><h3 class="text-lg font-bold text-stone-700 mb-3">التصنيفات</h3><div class="flex flex-wrap gap-2">${categoriesHTML}</div></div>` : ''}
                        </div>
                        ${relatedHadithsHTML}
                    `;
                    
                    document.getElementById('logical-search-btn').addEventListener('click', () => {
                         sessionStorage.setItem('hadithSearchQuery', hadith.text);
                         sessionStorage.removeItem('hadithSearchResults');
                         window.location.href = './index.html';
                    });

                    fabContainer.style.display = 'flex';
                } else {
                    renderError("لم يتم العثور على الحديث.");
                }
            } catch (err) {
                renderError(err.message);
            }
        };
        
        // --- INITIALIZATION ---
        initFontSizeControl();
        makeFabDraggable();
        loadHadith();
    });
  </script>
</body>
</html>
