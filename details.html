<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>تفاصيل الحديث</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Amiri', serif;
        background-color: #FDF6E3; /* Vintage paper background */
      }
       .animate-spin {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    </style>
</head>
<body>
    <div id="root" class="max-w-4xl mx-auto p-4 sm:p-6 md:p-8">
        <div id="loader-container" class="flex justify-center items-center h-screen">
             <div class="flex justify-center items-center p-8">
                <div class="w-12 h-12 border-4 border-amber-500 border-t-transparent rounded-full animate-spin"></div>
            </div>
        </div>
        <p id="error-container" class="text-center text-red-500 mt-10 hidden"></p>
        <div id="details-container" class="hidden">
             <!-- Content will be injected here -->
        </div>
    </div>

    <script type="module">
        const ORDS_API_BASE_URL = "https://g85b062bd5c6cb1-fatwaproject.adb.me-dubai-1.oraclecloudapps.com/ords/SUFEAN/hadeeth";
        
        const loaderContainer = document.getElementById('loader-container');
        const errorContainer = document.getElementById('error-container');
        const detailsContainer = document.getElementById('details-container');

        const createDetailCard = (title, content, isHtml = false) => {
            if (!content || content.trim() === '') return '';
            const contentHtml = isHtml ? content : `<p class="text-stone-700 whitespace-pre-wrap leading-loose text-lg">${content}</p>`;
            return `
                <div class="border-b border-stone-200 pb-4 mb-4">
                    <h2 class="text-2xl font-bold text-amber-800 mb-2">${title}</h2>
                    ${contentHtml}
                </div>
            `;
        };
        
        const createMetadataBlock = (hadith) => {
            const metadataPoints = [
                { label: 'الراوي', value: hadith.rawi },
                { label: 'المحدث', value: hadith.muhaddith },
                { label: 'المصدر', value: hadith.source },
                { label: 'الصفحة أو الرقم', value: hadith.page_number },
                { label: 'الحكم', value: hadith.hukm },
                { label: 'التخريج', value: hadith.takhrij },
            ];

            const itemsHtml = metadataPoints
                .filter(item => item.value)
                .map(item => `
                    <div class="py-2 px-3 bg-stone-100/70 rounded-md flex items-baseline">
                        <strong class="text-stone-600 font-bold ml-3 flex-shrink-0">${item.label}:</strong>
                        <span class="text-stone-800">${item.value}</span>
                    </div>
                `).join('');
            
            if (!itemsHtml) return '';

            return `
                <div class="border-b border-stone-200 pb-4 mb-6">
                    <h2 class="text-2xl font-bold text-amber-800 mb-3">بيانات الحديث</h2>
                    <div class="space-y-2 text-md">
                        ${itemsHtml}
                    </div>
                </div>
            `;
        };

        const cleanSharhText = (sharh) => {
            if (!sharh) return '';
            let cleaned = sharh.trim().replace('﻿', '');
            
            const commonSharhStarters = [
                'في هذا الحَديثِ', 'في هذا الحديث', 'وهذا الحديث', 'في الحديث',
                'ومعنى الحديث', 'وهذا بيانٌ', 'وقولُه صلَّى اللهُ', 'والمعنى', 'يبيِّنُ النَّبيُّ',
                'يُرشِدُ النَّبيُّ', 'يُعلِّمُنا'
            ].join('|');

            const blockRegex = new RegExp(`(الراوي\\s*:[\\s\\S]*?التخريج\\s*:[\\s\\S]*?)(?=${commonSharhStarters})`);
            const match = cleaned.match(blockRegex);
            
            if (match && match[0]) {
                 cleaned = cleaned.replace(match[0], '');
            } else {
                 const simplerRegex = new RegExp(`(الراوي\\s*:.*?)(${commonSharhStarters})`);
                 const simpleMatch = cleaned.match(simplerRegex);
                 if(simpleMatch && simpleMatch[1]) {
                    cleaned = cleaned.replace(simpleMatch[1], '');
                 }
            }
            return cleaned.trim();
        };

        const renderHadith = (hadith) => {
            const categoriesHtml = hadith.categories 
                ? hadith.categories.split('-').map(cat => cat.trim()).filter(Boolean).map(cat => 
                    `<a href="./category.html?q=${encodeURIComponent(cat)}" class="inline-block bg-amber-100 text-amber-800 text-sm font-medium me-2 px-3 py-1 rounded-full hover:bg-amber-200 transition-colors duration-200 border border-amber-300">
                        ${cat}
                    </a>`
                ).join('')
                : '';
            
            const cleanedSharh = cleanSharhText(hadith.sharh);
            const sharhFormattedHtml = `<p class="text-stone-700 whitespace-pre-wrap leading-loose text-lg">${cleanedSharh}</p>`;
            const metadataHtml = createMetadataBlock(hadith);

            const contentHtml = `
                <div class="bg-[#FFFBF2] rounded-xl shadow-lg p-6 sm:p-8 border-2 border-stone-200">
                    ${createDetailCard("الحديث", hadith.text)}
                    ${metadataHtml}
                    ${createDetailCard("الشرح", sharhFormattedHtml, true)}

                    ${categoriesHtml ? `
                    <div class="mt-4 mb-6">
                        <h3 class="text-lg font-bold text-stone-700 mb-3">التصنيفات</h3>
                        <div class="flex flex-wrap gap-2">${categoriesHtml}</div>
                    </div>` : ''}

                    <div class="mt-8">
                        <a href="./index.html" class="inline-block px-6 py-3 bg-stone-600 text-white font-bold rounded-lg hover:bg-stone-700 transition-colors duration-200">
                            رجوع للبحث
                        </a>
                    </div>
                </div>
            `;
            detailsContainer.innerHTML = contentHtml;
            loaderContainer.classList.add('hidden');
            detailsContainer.classList.remove('hidden');
        };

        const showError = (message) => {
            loaderContainer.classList.add('hidden');
            errorContainer.textContent = message;
            errorContainer.classList.remove('hidden');
        };

        const fetchHadith = async () => {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');

            if (!id) {
                showError("لم يتم تحديد حديث.");
                return;
            }

            try {
                const response = await fetch(`${ORDS_API_BASE_URL}/search_by_id/${id}`);
                const contentType = response.headers.get("content-type");
                
                if (!response.ok || !contentType || !contentType.includes("application/json")) {
                    throw new Error('حدث خطأ في جلب البيانات أو أن الحديث غير موجود.');
                }
                const data = await response.json();
                if (data.items && data.items.length > 0) {
                    renderHadith(data.items[0]);
                } else {
                    showError("لم يتم العثور على الحديث.");
                }
            } catch (err) {
                showError(err.message);
            }
        };

        fetchHadith();
    </script>
</body>
</html>
