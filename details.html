<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>تفاصيل الحديث</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Add ES Module Shim for browser compatibility with import maps -->
  <script async src="https://ga.jspm.io/npm:es-module-shims@1.10.0/dist/es-module-shims.js"></script>
  <script type="importmap">
  {
    "imports": {
      "@google/genai": "https://esm.run/@google/genai"
    }
  }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
    body {
      font-family: 'Tajawal', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <div class="container mx-auto max-w-4xl px-4 py-8 md:py-12">
    <div class="bg-white p-6 md:p-10 rounded-2xl shadow-lg border border-gray-200/80">
      
      <h1 id="hadith-title" class="text-3xl md:text-4xl font-bold text-gray-800 mb-6 border-b border-gray-200 pb-4">
        تفاصيل الحديث
      </h1>

      <div class="space-y-6">
        <div>
          <h2 class="text-lg font-bold text-gray-700 mb-1">الحديث:</h2>
          <p class="value text-lg text-gray-600 leading-relaxed whitespace-pre-line" id="text">جاري التحميل...</p>
        </div>
        <div>
          <h2 class="text-lg font-bold text-gray-700 mb-1">الشرح:</h2>
          <p class="value text-lg text-gray-600 leading-relaxed whitespace-pre-line" id="sharh">—</p>
        </div>
        <div>
          <h2 class="text-lg font-bold text-gray-700 mb-1">الراوي:</h2>
          <p class="value text-lg text-gray-600" id="rawi">—</p>
        </div>
        <div>
          <h2 class="text-lg font-bold text-gray-700 mb-1">المحدث:</h2>
          <p class="value text-lg text-gray-600" id="muhaddith">—</p>
        </div>
        <div>
          <h2 class="text-lg font-bold text-gray-700 mb-1">المصدر:</h2>
          <p class="value text-lg text-gray-600" id="source">—</p>
        </div>
        <div>
          <h2 class="text-lg font-bold text-gray-700 mb-1">الحكم:</h2>
          <p class="value text-lg text-gray-600" id="hukm">—</p>
        </div>
        <div>
          <h2 class="text-lg font-bold text-gray-700 mb-1">الصفحة او الرقم:</h2>
          <p class="value text-lg text-gray-600" id="page_number">—</p>
        </div>
        <div>
          <h2 class="text-lg font-bold text-gray-700 mb-1">التخريج:</h2>
          <p class="value text-lg text-gray-600 leading-relaxed whitespace-pre-line" id="takhrij">—</p>
        </div>
        <div>
          <h2 class="text-lg font-bold text-gray-700 mb-2">التصنيف:</h2>
          <div class="value" id="categories">—</div>
        </div>
      </div>
      
      <div class="mt-8 pt-6 border-t border-gray-200">
        <h2 class="text-2xl font-bold text-gray-700 mb-4">
          خلاصة الرواية <span class="text-sm font-medium bg-blue-100 text-blue-800 py-1 px-2 rounded-full align-middle">BETA</span>
        </h2>
        <div id="ai-summary" class="bg-gray-100 p-5 rounded-lg text-gray-700 leading-relaxed whitespace-pre-line min-h-[80px]">
          <div id="summary-loader" class="flex items-center gap-3">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="h-6 w-6 text-blue-500 animate-spin">
              <path clip-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm0 1.5a8.25 8.25 0 100 16.5 8.25 8.25 0 000-16.5z" fill="currentColor" fill-opacity="0.2"></path>
              <path d="M12 2.25a.75.75 0 01.75.75v3a.75.75 0 01-1.5 0v-3A.75.75 0 0112 2.25z" fill="currentColor"></path>
            </svg>
            <span>جاري إنشاء خلاصة بالذكاء الاصطناعي...</span>
          </div>
        </div>
      </div>

      <div class="mt-10 pt-6 border-t border-gray-200 flex items-center gap-4">
        <a href="index.html" class="inline-flex items-center gap-2 px-5 py-2.5 bg-gray-600 text-white font-semibold text-base rounded-full hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors duration-200">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM13.5 10.5h-6" />
          </svg>
          <span>رجوع للبحث</span>
        </a>
        <button id="add-btn" class="inline-flex items-center gap-2 px-5 py-2.5 bg-blue-600 text-white font-semibold text-base rounded-full hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-200 disabled:bg-gray-300 disabled:cursor-not-allowed">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
            <span>إضافة للمختارة</span>
        </button>
      </div>
    </div>
  </div>

<script type="module">
import { GoogleGenAI } from '@google/genai';

const PROMPT_TEMPLATE = `أعد صياغة وصف الحديث على هذا النمط (مختصر – مصادر فقط – لا رأي شخصي):

أصل الرواية الصحيح
عن [اسم الصحابي] مرفوعًا: "[نص الحديث]".
المصادر:
– [الكتاب] رقم [الرقم]. رابط (إن توفر).
– …
الحكم على الإسناد: [صحيح / حسن / ضعيف] واذكر أسماء العلماء فقط.

إذا وُجدت زيادات لا تصح: ضع عنوان (زيادات لا تثبت)
إذا وُجد شاهد ضعيف: ضع عنوان (شواهد أخرى ضعيفة)
أختم بخلاصة قصيرة جدًا.

مهم: لا تكتب أي رأي أو تحليل، فقط مصادر وأحكام المحدثين.`;

async function generateAndDisplaySummary(hadith) {
    const summaryContainer = document.getElementById("ai-summary");
    
    const hadithText = hadith.text;
    const sourceAndTakhrij = `${hadith.source || ''} - ${hadith.takhrij || ''}`.trim();
    const ruling = hadith.hukm;

    if (!hadithText || !ruling) {
        summaryContainer.innerHTML = "<p>لا يمكن إنشاء خلاصة لعدم توفر معلومات كافية.</p>";
        return;
    }

    try {
        if (!process.env.API_KEY) {
            summaryContainer.innerHTML = "<p>ميزة الخلاصة غير متاحة حاليًا. مفتاح API غير معرف في بيئة التشغيل.</p>";
            console.error("API_KEY environment variable not set.");
            return;
        }
        const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

        const fullPrompt = `المدخلات:
الحديث: ${hadithText}
المصدر والتخريج: ${sourceAndTakhrij}
حكم المحدث: ${ruling}

الطلب:
${PROMPT_TEMPLATE}`;

        const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: fullPrompt,
        });

        summaryContainer.innerHTML = `<p>${response.text}</p>`;

    } catch (error) {
        console.error("Error generating summary:", error);
        let errorMessage = "عذرًا، حدث خطأ أثناء إنشاء الخلاصة. يرجى المحاولة مرة أخرى لاحقًا.";
    
        const errorText = error.toString().toLowerCase();
        if (errorText.includes("api key not valid") || errorText.includes("400") || errorText.includes("api_key_invalid")) {
            errorMessage = "فشلت المصادقة. يبدو أن مفتاح API المقدم من البيئة غير صالح أو منتهي الصلاحية.";
        } else if (errorText.includes("quota")) {
            errorMessage = "تم تجاوز حصة الاستخدام لمفتاح API. يرجى المحاولة مرة أخرى لاحقًا.";
        }
        
        summaryContainer.innerHTML = `<p>${errorMessage}</p>`;
    }
}

function setupAddButton(hadith) {
    const addButton = document.getElementById('add-btn');
    if (!addButton) return;

    const getSelectedHadiths = () => {
        const stored = localStorage.getItem('selectedHadiths');
        return stored ? JSON.parse(stored) : [];
    };

    const saveSelectedHadiths = (hadiths) => {
        localStorage.setItem('selectedHadiths', JSON.stringify(hadiths));
    };

    let selectedHadiths = getSelectedHadiths();
    const isAdded = selectedHadiths.some(h => String(h.id) === String(hadith.id));

    if (isAdded) {
        addButton.disabled = true;
        addButton.textContent = 'تمت الإضافة';
    } else {
        addButton.addEventListener('click', () => {
            let currentSelected = getSelectedHadiths();
            if (!currentSelected.some(h => String(h.id) === String(hadith.id))) {
                const hadithSummary = {
                    id: hadith.id,
                    text: hadith.text,
                    muhaddith: hadith.muhaddith,
                    source: hadith.source,
                    hukm: hadith.hukm
                };
                // Add to the beginning and limit to 10
                const newSelected = [hadithSummary, ...currentSelected].slice(0, 10);
                saveSelectedHadiths(newSelected);
            }
            addButton.disabled = true;
            addButton.textContent = 'تمت الإضافة';
        });
    }
}


document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");

    if (!id) {
        document.getElementById("text").innerText = "لم يتم تحديد حديث لعرضه.";
        return;
    }

    const apiUrl = `https://g85b062bd5c6cb1-fatwaproject.adb.me-dubai-1.oraclecloudapps.com/ords/SUFEAN/hadeeth/search_by_id/${id}`;

    fetch(apiUrl)
      .then(res => {
          if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
          }
          return res.json();
      })
      .then(data => {
          if (!data.items || data.items.length === 0) {
              document.getElementById("text").innerText = "الحديث غير موجود.";
              return;
          }

          const h = data.items[0];

          document.getElementById("text").innerText        = h.text ?? "—";
          document.getElementById("sharh").innerText       = h.sharh ?? "—";
          document.getElementById("rawi").innerText        = h.rawi ?? "—";
          document.getElementById("muhaddith").innerText   = h.muhaddith ?? "—";
          document.getElementById("source").innerText      = h.source ?? "—";
          document.getElementById("hukm").innerText        = h.hukm ?? "—";
          document.getElementById("page_number").innerText = h.page_number ?? "—";
          document.getElementById("takhrij").innerText     = h.takhrij ?? "—";

          if (h.categories) {
            const parts = h.categories.split(" - ");
            document.getElementById("categories").innerHTML =
              parts.map(cat =>
                `<a class="inline-block bg-blue-100 text-blue-800 text-sm font-medium mr-2 mb-2 px-3 py-1.5 rounded-full hover:bg-blue-200 transition-colors" href="category.html?q=${encodeURIComponent(cat)}">${cat}</a>`
              ).join("");
          } else {
            document.getElementById("categories").innerHTML = "—";
          }
          
          setupAddButton(h);
          generateAndDisplaySummary(h);
      })
      .catch(err => {
          console.error(err);
          document.getElementById("text").innerText = "حدث خطأ أثناء تحميل البيانات.";
          const summaryContainer = document.getElementById("ai-summary");
          summaryContainer.innerHTML = "<p>لا يمكن إنشاء خلاصة بسبب خطأ في تحميل بيانات الحديث.</p>"
      });
});
</script>

</body>
</html>
