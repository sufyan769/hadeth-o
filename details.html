<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>تفاصيل الحديث</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Amiri', serif;
        background-color: #FDF6E3; /* Vintage paper background */
      }
       .animate-spin {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    </style>
</head>
<body>
    <div id="root" class="max-w-4xl mx-auto p-4 sm:p-6 md:p-8">
        <div id="loader-container" class="flex justify-center items-center h-screen">
             <div class="flex justify-center items-center p-8">
                <div class="w-12 h-12 border-4 border-amber-500 border-t-transparent rounded-full animate-spin"></div>
            </div>
        </div>
        <p id="error-container" class="text-center text-red-500 mt-10 hidden"></p>
        <div id="details-container" class="hidden">
             <!-- Content will be injected here -->
        </div>
    </div>

    <script type="module">
        const ORDS_API_BASE_URL = "https://g85b062bd5c6cb1-fatwaproject.adb.me-dubai-1.oraclecloudapps.com/ords/SUFEAN/hadeeth";
        
        const loaderContainer = document.getElementById('loader-container');
        const errorContainer = document.getElementById('error-container');
        const detailsContainer = document.getElementById('details-container');

        const formatSharh = (sharhText) => {
            if (!sharhText) return '';
            
            let text = sharhText.trim().replace('﻿', ''); // Remove leading BOM character if present

            const keywords = [
                'الراوي', 'المحدث', 'المصدر', 'الصفحة أو الرقم',
                'خلاصة حكم المحدث', 'التخريج'
            ];
            
            // Regex to find the entire metadata block. It's designed to be robust.
            const metadataRegex = /(الراوي\s*:[\s\S]*?التخريج\s*:[\s\S]*?(?:\)|\d))\s/;
            const match = text.match(metadataRegex);

            if (!match) {
                // No full block found, just return original text
                return `<p class="text-stone-700 whitespace-pre-wrap leading-loose text-lg">${text}</p>`;
            }
            
            const metadataBlock = match[1]; // Use the captured group
            const parts = text.split(metadataBlock);
            const beforeText = parts[0] || '';
            const afterText = parts[1] || '';

            let formattedMetadata = metadataBlock;
            keywords.forEach((key, index) => {
                const regex = new RegExp(`(${key}\\s*:)`, 'g');
                // Don't add a <br> for the first keyword, 'الراوي'
                const replacement = index === 0 ? `<strong>$1</strong>` : `<br><strong>$1</strong>`;
                formattedMetadata = formattedMetadata.replace(regex, replacement);
            });
            
             const metadataHtml = `
                <div class="my-6 p-4 bg-stone-100/80 border-r-4 border-stone-300 rounded-lg text-stone-800 leading-relaxed shadow-inner" style="font-size: 1.1rem;">
                    ${formattedMetadata}
                </div>
            `;
            
            let finalHtml = '';
            if (beforeText && beforeText.trim()) {
                finalHtml += `<p class="text-stone-700 whitespace-pre-wrap leading-loose text-lg">${beforeText.trim()}</p>`;
            }
            finalHtml += metadataHtml;
            if (afterText && afterText.trim()) {
                 finalHtml += `<p class="text-stone-700 whitespace-pre-wrap leading-loose text-lg mt-4">${afterText.trim()}</p>`;
            }

            return finalHtml;
        }

        const createDetailCard = (title, content, isHtml = false) => {
            if (!content) return '';
            const contentHtml = isHtml ? content : `<p class="text-stone-700 whitespace-pre-wrap leading-loose text-lg">${content}</p>`;
            return `
                <div class="border-b border-stone-200 pb-4 mb-4">
                    <h2 class="text-2xl font-bold text-amber-800 mb-2">${title}</h2>
                    ${contentHtml}
                </div>
            `;
        };

        const renderHadith = (hadith) => {
            const categoriesHtml = hadith.categories 
                ? hadith.categories.split('-').map(cat => cat.trim()).filter(Boolean).map(cat => 
                    `<a href="/Category.html?q=${encodeURIComponent(cat)}" class="inline-block bg-amber-100 text-amber-800 text-sm font-medium me-2 px-3 py-1 rounded-full hover:bg-amber-200 transition-colors duration-200 border border-amber-300">
                        ${cat}
                    </a>`
                ).join('')
                : '';
            
            const sharhFormattedHtml = formatSharh(hadith.sharh);

            const contentHtml = `
                <div class="bg-[#FFFBF2] rounded-xl shadow-lg p-6 sm:p-8 border-2 border-stone-200">
                    ${createDetailCard("الحديث", hadith.text)}
                    ${hadith.sharh ? createDetailCard("الشرح", sharhFormattedHtml, true) : ''}
                    ${createDetailCard("التخريج", hadith.takhrij)}

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 mb-6 text-md">
                        <div class="border-b border-stone-200 pb-2"><strong class="text-stone-600 font-bold ml-2">الراوي:</strong> ${hadith.rawi || 'غير مذكور'}</div>
                        <div class="border-b border-stone-200 pb-2"><strong class="text-stone-600 font-bold ml-2">المحدث:</strong> ${hadith.muhaddith || 'غير مذكور'}</div>
                        <div class="border-b border-stone-200 pb-2"><strong class="text-stone-600 font-bold ml-2">المصدر:</strong> ${hadith.source || 'غير مذكور'}</div>
                        <div class="border-b border-stone-200 pb-2"><strong class="text-stone-600 font-bold ml-2">الحكم:</strong> <span class="font-semibold text-amber-900">${hadith.hukm || 'غير مذكور'}</span></div>
                        <div class="border-b border-stone-200 pb-2"><strong class="text-stone-600 font-bold ml-2">الرقم أو الصفحة:</strong> ${hadith.page_number || 'غير مذكور'}</div>
                    </div>

                    ${categoriesHtml ? `
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-stone-700 mb-3">التصنيفات</h3>
                        <div class="flex flex-wrap gap-2">${categoriesHtml}</div>
                    </div>` : ''}

                    <div class="flex flex-col sm:flex-row gap-4 mt-8">
                        <a href="/" class="w-full sm:w-auto flex-grow text-center px-6 py-3 bg-stone-600 text-white font-bold rounded-lg hover:bg-stone-700 transition-colors duration-200">
                            رجوع للبحث
                        </a>
                        <button id="add-btn" class="w-full sm:w-auto flex-grow text-center px-6 py-3 font-bold rounded-lg transition-colors duration-200 bg-amber-500 text-white hover:bg-amber-600">
                            إضافة للمختارة
                        </button>
                    </div>
                </div>
            `;
            detailsContainer.innerHTML = contentHtml;
            loaderContainer.classList.add('hidden');
            detailsContainer.classList.remove('hidden');

            const addButton = document.getElementById('add-btn');
            const selectedHadiths = JSON.parse(localStorage.getItem('selectedHadiths') || '[]');
            const isAdded = selectedHadiths.some(h => h.id === hadith.id);
            if (isAdded) {
                addButton.disabled = true;
                addButton.textContent = 'تمت الإضافة';
                addButton.className += ' bg-stone-300 text-stone-500 cursor-not-allowed';
            } else {
                addButton.addEventListener('click', () => {
                    const currentSelected = JSON.parse(localStorage.getItem('selectedHadiths') || '[]');
                    if (!currentSelected.some(h => h.id === hadith.id)) {
                        const newSelected = [hadith, ...currentSelected];
                        localStorage.setItem('selectedHadiths', JSON.stringify(newSelected));
                    }
                    addButton.disabled = true;
                    addButton.textContent = 'تمت الإضافة';
                    addButton.className = 'w-full sm:w-auto flex-grow text-center px-6 py-3 font-bold rounded-lg transition-colors duration-200 bg-stone-300 text-stone-500 cursor-not-allowed';
                });
            }
        };

        const showError = (message) => {
            loaderContainer.classList.add('hidden');
            errorContainer.textContent = message;
            errorContainer.classList.remove('hidden');
        };

        const fetchHadith = async () => {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');

            if (!id) {
                showError("لم يتم تحديد حديث.");
                return;
            }

            try {
                const response = await fetch(`${ORDS_API_BASE_URL}/search_by_id/${id}`);
                const contentType = response.headers.get("content-type");
                
                if (!response.ok || !contentType || !contentType.includes("application/json")) {
                    throw new Error('حدث خطأ في جلب البيانات أو أن الحديث غير موجود.');
                }
                const data = await response.json();
                if (data.items && data.items.length > 0) {
                    renderHadith(data.items[0]);
                } else {
                    showError("لم يتم العثور على الحديث.");
                }
            } catch (err) {
                showError(err.message);
            }
        };

        fetchHadith();
    </script>
</body>
</html>
