
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>تفاصيل الحديث - موسوعة الحديث</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400;1,700&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              amiri: ['Amiri', 'serif'],
              cairo: ['Cairo', 'sans-serif'],
            },
          },
        },
      }
    </script>
    <style>
      body {
        font-family: 'Amiri', serif;
      }
      h1, h2, h3, h4, h5, h6, button, a {
        font-family: 'Cairo', 'sans-serif';
      }
      .loader {
        width: 48px;
        height: 48px;
        border: 4px solid #14b8a6;
        border-bottom-color: transparent;
        border-radius: 50%;
        display: inline-block;
        box-sizing: border-box;
        animation: rotation 1s linear infinite;
      }
      @keyframes rotation {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app-container" class="max-w-5xl mx-auto p-4 md:p-6">
        <header class="bg-white/80 backdrop-blur-sm sticky top-4 z-10 p-3 rounded-lg shadow-md border border-gray-200">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                     <button onclick="history.back()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition-colors text-sm">
                            عودة
                     </button>
                     <a href="/hadeth-o/index.html">
                        <h1 class="text-lg md:text-2xl font-bold text-gray-800 hover:text-teal-600 transition-colors">موسوعة الحديث</h1>
                     </a>
                </div>
                <button id="font-size-toggle" class="bg-teal-600 text-white px-4 py-2 rounded-md hover:bg-teal-700 transition-colors" aria-label="تغيير حجم الخط">
                    <span>حجم الخط: 16</span>
                </button>
            </div>
        </header>
        
        <main id="main-content" class="mt-4">
            <div id="loader" class="text-center p-8"><div class="loader mx-auto"></div></div>
            <div id="error-message" class="hidden text-center text-red-500 bg-red-100 p-4 rounded-md"></div>
            <div id="details-container" class="hidden"></div>
        </main>
    </div>

    <script type="module">
        // --- API CONFIG ---
        const ALGOLIA_APP_ID = '3XD12I7386';
        const ALGOLIA_SEARCH_KEY = '89e8e132a05fdb02275f64dec8d14d05';
        const ALGOLIA_INDEX_NAME = 'ahadith_clean';
        const ALGOLIA_URL = `https://${ALGOLIA_APP_ID}-dsn.algolia.net/1/indexes/${ALGOLIA_INDEX_NAME}/query`;
        const ORACLE_BASE_URL = 'https://g85b062bd5c6cb1-fatwaproject.adb.me-dubai-1.oraclecloudapps.com/ords/SUFEAN';

        // --- UI ELEMENTS ---
        const mainContent = document.getElementById('main-content');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const detailsContainer = document.getElementById('details-container');

        // --- STATE ---
        let hadithDetail = null;
        let similarAhadith = [];

        // --- HELPER FUNCTIONS ---
        function toggleLoader(show) {
            loader.style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        // --- API FUNCTIONS ---
        const algoliaHeaders = {
            'X-Algolia-Application-Id': ALGOLIA_APP_ID,
            'X-Algolia-API-Key': ALGOLIA_SEARCH_KEY,
            'Content-Type': 'application/json',
        };

        async function getHadithDetails(id) {
            const response = await fetch(`${ORACLE_BASE_URL}/hadith_full_api/${id}`);
            if (!response.ok) throw new Error('Failed to fetch hadith details');
            const data = await response.json();
            return data.items && data.items.length > 0 ? data.items[0] : null;
        }

        async function getHadithFromAlgolia(id) {
            const url = `https://${ALGOLIA_APP_ID}-dsn.algolia.net/1/indexes/${ALGOLIA_INDEX_NAME}/${id}`;
            const response = await fetch(url, {
                method: 'GET',
                headers: algoliaHeaders,
            });
            if (!response.ok) return null; // Gracefully handle not found
            return await response.json();
        }

        async function getSimilarAhadith(query, count = 5) {
            const params = { query, hitsPerPage: count };
            const response = await fetch(ALGOLIA_URL, {
                method: 'POST',
                headers: algoliaHeaders,
                body: JSON.stringify(params),
            });
            if (!response.ok) throw new Error('Failed to fetch similar ahadith');
            const data = await response.json();
            return data.hits;
        }

        // --- RENDER FUNCTIONS ---
        function renderDetailsPage(hadith) {
            const hadithText = hadith.text || hadith.hadith_text || hadith.hadith;
            const explanation = [hadith.sharh1, hadith.sharh2, hadith.sharh3, hadith.sharh4, hadith.sharh5, hadith.sharh6]
                .filter(Boolean).join('<br/><br/>');
            const categories = (typeof hadith.categories === 'string' ? hadith.categories.split('|') : [])
                .map(c => c.trim()).filter(Boolean);


            detailsContainer.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">
                            <p class="leading-loose text-2xl mb-6 font-amiri" style="line-height: 2">${hadithText || '...'}</p>
                            <div class="flex flex-wrap gap-2 mb-8">
                                <button id="copy-btn" class="bg-teal-600 text-white px-4 py-2 rounded-md hover:bg-teal-700 transition-colors">نسخ</button>
                                <button id="search-similar-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition-colors">بحث عن المشابه</button>
                            </div>
                            ${explanation ? `
                                <div class="mt-8">
                                    <h2 class="text-2xl font-bold font-cairo border-b-2 border-teal-500 pb-2 mb-4">الشرح والتفسير</h2>
                                    <div class="prose max-w-none leading-relaxed">${explanation}</div>
                                </div>` : ''}
                        </div>
                        <div class="lg:col-span-1">
                             <div class="bg-gray-100 border border-gray-200 rounded-lg p-4 lg:sticky lg:top-24">
                                <h2 class="text-xl font-bold font-cairo border-b-2 border-teal-500 pb-2 mb-4">بطاقة الحديث</h2>
                                <dl>
                                    ${renderInfoRow("الراوي", hadith.rawi)}
                                    ${renderInfoRow("المحدث", hadith.muhaddith)}
                                    ${renderInfoRow("المصدر", hadith.source)}
                                    ${renderInfoRow("الصفحة/الرقم", hadith.page_number)}
                                    ${renderInfoRow("الحكم", hadith.hukm)}
                                    ${renderInfoRow("التخريج", hadith.takhrij)}
                                </dl>
                            </div>
                        </div>
                    </div>
                    ${categories.length > 0 ? `
                        <div class="mt-8 pt-6 border-t border-gray-200">
                            <h3 class="text-xl font-bold font-cairo mb-3">تصنيفات</h3>
                            <div class="flex flex-wrap gap-2">
                                ${categories.map(cat => `<a href="/hadeth-o/category.html?name=${encodeURIComponent(cat)}" class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-200 transition-colors">${cat}</a>`).join('')}
                            </div>
                        </div>` : ''}
                    <div id="similar-section" class="mt-8 pt-6 border-t border-gray-200"></div>
                </div>
            `;
            attachActionListeners();
            detailsContainer.style.display = 'block';
        }
        
        function renderInfoRow(label, value) {
            if (!value) return '';
            return `
                <div class="flex justify-between border-b border-gray-200 py-2">
                    <dt class="font-bold text-gray-800">${label}</dt>
                    <dd class="text-gray-600 text-left">${value}</dd>
                </div>
            `;
        }

        function renderSimilarSection(similar) {
             const similarSection = document.getElementById('similar-section');
             if (!similarSection || similar.length === 0) return;

             similarSection.innerHTML = `
                <h2 class="text-2xl font-bold font-cairo mb-4">أحاديث ذات صلة</h2>
                <ul class="list-disc pr-5 space-y-2 mb-4">
                    ${similar.map(s => {
                        const text = s.text || s.hadith_text || s.hadith || '';
                        return `<li><a href="/hadeth-o/details.html?id=${s.objectID}" class="text-teal-600 hover:underline">${text.substring(0, 100)}...</a></li>`
                    }).join('')}
                </ul>
                <button id="show-full-similar-btn" class="bg-teal-100 text-teal-800 px-4 py-2 rounded-md hover:bg-teal-200 transition-colors disabled:opacity-50">
                    عرض كل الروايات المشابهة
                </button>
                <div id="full-similar-container" class="mt-6 space-y-6"></div>
             `;
             document.getElementById('show-full-similar-btn').addEventListener('click', handleShowFullSimilar);
        }
        
        function renderFullSimilar(fullSimilarList) {
            const container = document.getElementById('full-similar-container');
            container.innerHTML = fullSimilarList.map(full => {
                const hadithText = full.text || full.hadith_text || full.hadith;
                return `
                <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                     <p class="leading-relaxed mb-3">${hadithText || '...'}</p>
                     <div class="text-sm text-gray-500">
                        <p><span class="font-bold text-gray-700">المصدر:</span> ${full.source}</p>
                        <p><span class="font-bold text-gray-700">الحكم:</span> <span class="text-green-700 font-bold">${full.hukm}</span></p>
                     </div>
                 </div>
            `}).join('');
            document.getElementById('show-full-similar-btn').style.display = 'none';
        }

        // --- EVENT HANDLERS ---
        function attachActionListeners() {
            document.getElementById('copy-btn').addEventListener('click', handleCopy);
            document.getElementById('search-similar-btn').addEventListener('click', handleSearchSimilar);
        }

        function handleCopy() {
            const btn = document.getElementById('copy-btn');
            if (!hadithDetail) return;
            const hadithText = hadithDetail.text || hadithDetail.hadith_text || hadithDetail.hadith;
            const sharh = [hadithDetail.sharh1, hadithDetail.sharh2, hadithDetail.sharh3, hadithDetail.sharh4, hadithDetail.sharh5, hadithDetail.sharh6]
                .filter(Boolean).join('\n\n');
            const textToCopy = `
نص الحديث:
${hadithText}
---
الراوي: ${hadithDetail.rawi}
المحدث: ${hadithDetail.muhaddith}
المصدر: ${hadithDetail.source}
الصفحة/الرقم: ${hadithDetail.page_number}
الحكم: ${hadithDetail.hukm}
التخريج: ${hadithDetail.takhrij}
---
الشرح:
${sharh || 'لا يوجد شرح متاح.'}
            `.trim();
            navigator.clipboard.writeText(textToCopy).then(() => {
                btn.textContent = 'تم النسخ!';
                setTimeout(() => { btn.textContent = 'نسخ'; }, 2000);
            });
        }
        
        function handleSearchSimilar() {
            if (!hadithDetail) return;
            const hadithText = hadithDetail.text || hadithDetail.hadith_text || hadithDetail.hadith;
            window.location.href = `/hadeth-o/index.html?query=${encodeURIComponent(hadithText)}`;
        }

        async function handleShowFullSimilar() {
            const btn = document.getElementById('show-full-similar-btn');
            btn.disabled = true;
            btn.textContent = 'جاري التحميل...';
            try {
                const detailsPromises = similarAhadith.map(h => getHadithDetails(h.objectID));
                const details = await Promise.all(detailsPromises);
                renderFullSimilar(details.filter(Boolean));
            } catch (error) {
                console.error("Failed to fetch full similar details:", error);
                btn.textContent = 'حدث خطأ';
            }
        }
        
        // --- FONT SIZE LOGIC ---
        const fontSizes = [
            { size: 16, class: 'text-base' }, { size: 18, class: 'text-lg' },
            { size: 20, class: 'text-xl' }, { size: 24, class: 'text-2xl' },
        ];
        let currentFontSizeIndex = 0;

        function applyFontSize(index) {
            const appContainer = document.getElementById('app-container');
            const toggleButton = document.getElementById('font-size-toggle');
            fontSizes.forEach(fs => appContainer.classList.remove(fs.class));
            appContainer.classList.add(fontSizes[index].class);
            toggleButton.querySelector('span').textContent = `حجم الخط: ${fontSizes[index].size}`;
            localStorage.setItem('hadithAppFontSize', fontSizes[index].size.toString());
            currentFontSizeIndex = index;
        }

        // --- MAIN INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            const savedSize = localStorage.getItem('hadithAppFontSize');
            const initialIndex = savedSize ? fontSizes.findIndex(fs => fs.size.toString() === savedSize) : 0;
            applyFontSize(initialIndex !== -1 ? initialIndex : 0);
            document.getElementById('font-size-toggle').addEventListener('click', () => {
                const nextIndex = (currentFontSizeIndex + 1) % fontSizes.length;
                applyFontSize(nextIndex);
            });

            const params = new URLSearchParams(window.location.search);
            const hadithId = params.get('id');
            if (!hadithId) {
                showError('لم يتم تحديد معرّف الحديث.');
                toggleLoader(false);
                return;
            }

            try {
                const [oracleResult, algoliaResult] = await Promise.all([
                    getHadithDetails(hadithId).catch(e => { console.error("Oracle fetch failed:", e); return null; }),
                    getHadithFromAlgolia(hadithId).catch(e => { console.error("Algolia fetch failed:", e); return null; })
                ]);

                if (!oracleResult && !algoliaResult) {
                    showError('لم يتم العثور على الحديث.');
                    toggleLoader(false);
                    return;
                }

                hadithDetail = {
                    ...(oracleResult || {}),
                    ...(algoliaResult || {}),
                    text: oracleResult?.text || algoliaResult?.text,
                    rawi: algoliaResult?.rawi || oracleResult?.rawi,
                    muhaddith: algoliaResult?.muhaddith || oracleResult?.muhaddith,
                    hukm: algoliaResult?.hukm || oracleResult?.hukm,
                    source: algoliaResult?.source || oracleResult?.source,
                };
                
                const hadithText = hadithDetail.text;

                if (hadithText) {
                    renderDetailsPage(hadithDetail);
                    document.title = `${hadithText.substring(0, 50)}... - موسوعة الحديث`;

                    // Fetch similar in background, but don't let it break the page
                    (async () => {
                        try {
                            const similarData = await getSimilarAhadith(hadithText, 6);
                            const currentHadithId = algoliaResult?.objectID || oracleResult?.id;
                            if (Array.isArray(similarData)) {
                                similarAhadith = similarData.filter(h => h.objectID != currentHadithId).slice(0, 5);
                                if (similarAhadith.length > 0) {
                                    renderSimilarSection(similarAhadith);
                                }
                            }
                        } catch (error) {
                            console.error('Could not load similar ahadith:', error);
                            const similarSection = document.getElementById('similar-section');
                            if (similarSection) similarSection.style.display = 'none';
                        }
                    })();

                } else {
                    showError('نص الحديث غير متوفر.');
                }
            } catch (error) {
                console.error("Main page load error:", error);
                showError('حدث خطأ أثناء جلب تفاصيل الحديث.');
            } finally {
                toggleLoader(false);
            }
        });
    </script>

</body>
</html>
